#!/bin/bash -eu
#
# Configure a Raspberry Pi system
#

function out()
{
	rc=${?}

	trap - EXIT INT TERM HUP

	if [ "${rc}" -ne 0 ] ; then
		echo "** Error: Script failed" >&2
	fi

	exit "${rc}"
}

function usage()
{
	cat <<EOF
Usage: configure-image [-h] ROOT_DIR|BOOT_DIR

Configure a Raspberry Pi system.

Positional arguments:
  ROOT_DIR    The root directory of the system to configure.
  BOOT_DIR    The boot directory of the system to configure.

Optional arguments:
  -h, --help  Show this help text and exit.
EOF
}

HERE=$(cd "$(dirname "${BASH_SOURCE[0]}")" >/dev/null 2>&1 && pwd)

root_boot_dir=

while [ "${#}" -gt 0 ] ; do
	case "${1}" in
		-h|--help)
			usage
			exit
			;;
		*)
			if [ -z "${root_boot_dir}" ] ; then
				root_boot_dir=${1}
			else
				echo "** Error: Invalid argument: ${1}" >&2
				exit 2
			fi
			;;
	esac
	shift
done

if [ -z "${root_boot_dir}" ] ; then
	usage
	exit 2
fi

trap out EXIT INT TERM HUP

if [ -e "${root_boot_dir}"/config.txt ] ; then
	BOOT_DIR=${root_boot_dir}
	ROOT_DIR=
else
	ROOT_DIR=${root_boot_dir}
	if [ -e "${ROOT_DIR}"/boot/firmware/config.txt ] ; then
		BOOT_DIR=${ROOT_DIR}/boot/firmware
	elif  [ -e "${ROOT_DIR}"/boot/config.txt ] ; then
		BOOT_DIR=${ROOT_DIR}/boot
	else
		echo "** Error: Boot directory not found" >&2
		exit 1
	fi
fi

if [ -e "${BOOT_DIR}"/nobtcmd.txt ] ; then
	CMDLINE_TXT="${BOOT_DIR}"/nobtcmd.txt
else
	CMDLINE_TXT="${BOOT_DIR}"/cmdline.txt
fi

export BOOT_DIR ROOT_DIR CMDLINE_TXT

"${HERE}"/../hooks/set-cmdline "console=tty1" "console=serial0,115200" \
                               "ignore_loglevel" \
                               "usb-storage.quirks=152d:0579:u"

if [ -z "${ROOT_DIR}" ] ; then
	exit
fi

"${HERE}"/../hooks/remove-packages unattended-upgrades needrestart ubiquity oem-config
"${HERE}"/../hooks/install-packages openssh-server sudo
"${HERE}"/../hooks/install-tools
"${HERE}"/../hooks/set-cloudinit-config
"${HERE}"/../hooks/set-hostname
"${HERE}"/../hooks/add-user ubuntu
"${HERE}"/../hooks/set-service enable ssh

# Configure desktop images
if [ -e "${ROOT_DIR}"/usr/share/doc/ubuntu-desktop/copyright ] ; then
	"${HERE}"/../hooks/set-service set-default graphical.target
	"${HERE}"/../hooks/enable-auto-login ubuntu
fi

# enable_wifi
"${HERE}"/../hooks/add-net-module r8152

"${HERE}"/../hooks/hacks
