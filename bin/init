#!/bin/sh

BASE_URL=http://192.168.99.11/images/

# ----------------------------------------------------------------------------
# Helper functions

do_flash_image()
{
	image_url=${1} compressor=${2} boot_dev=${3}

	rm -f .fail

	{
		/usr/bin/wget -O - "$image_url}" || touch .fail
	} | {
		/usr/bin/"${compressor}" -cd || touch .fail
	} | {
		/bin/dd of="${boot_dev}" bs=4k conv=fsync status=none || touch .fail
	}

	if [ -e .fail ] ; then
		return 1
	fi
}

flash_image()
{
	image_url=${1} boot_dev=${2}

	for compressor in xz gzip ; do
		if do_flash_image "${image_url}" "${compressor}" "${boot_dev}" ; then
			return
		fi
	done

	return 1
}

# ----------------------------------------------------------------------------
# Main entry point

echo "-- Run installer"

# Initial setup
/bin/busybox --install /bin

[ -d /dev ] || mkdir -m 0755 /dev
[ -d /root ] || mkdir -m 0700 /root
[ -d /sys ] || mkdir /sys
[ -d /proc ] || mkdir /proc
[ -d /tmp ] || mkdir /tmp
[ -d /boot ] || mkdir /boot
mkdir -p /var/lock
mount -t sysfs -o nodev,noexec,nosuid sysfs /sys
mount -t proc -o nodev,noexec,nosuid proc /proc

mount -t devtmpfs -o nosuid,mode=0755 udev /dev
mkdir /dev/pts
mount -t devpts -o noexec,nosuid,gid=5,mode=0620 devpts /dev/pts || true

mkdir -p /etc /var/lib/dhcp /var/run
touch /etc/fstab

# Load necessary kernel modules
echo "-- Load kernel modules"
depmod
modprobe r8152
modprobe uas

# Wait for the root device
echo "-- Wait for /dev/mmcblk0p1 or /dev/sda1"
for _ in $(seq 10) ; do
	if [ -b /dev/mmcblk0p1 ] ; then
		boot_dev=/dev/mmcblk0
		break
	elif [ -b /dev/sda1 ] ; then
		boot_dev=/dev/sda
		break
	fi
	sleep .5
done

# Wait for the network device
echo "-- Wait for /sys/class/net/eth0"
for _ in $(seq 10) ; do
	[ -e /sys/class/net/eth0 ] && break
	sleep .5
done

# Get an IP address
echo "-- Get an IP address"
dhclient -v

# Get the list of available images
echo "-- Get the list of available images"
/usr/bin/wget -O images.list "${BASE_URL}"/images

# Main loop
image=
while true ; do
	# Flash the selected image to the selected boot device
	if [ -n "${image}" ] ; then
		image_url="${BASE_URL}/${image}"
		echo "-- Flash image ${image_url} to ${boot_dev}"
		if flash_image "${image_url}" "${boot_dev}" ; then
			echo "-- Image flashed, rebooting..."
			sync
			reboot -f
		else
			echo "-- Failed to flash image"
		fi
	fi

	cat <<EOF

-- Select an image to flash to ${boot_dev}

$(cat images.list)

   90) Run a shell
   91) Enter an image name manually
   92) Change the boot device (${boot_dev})
   99) Reboot

EOF

	printf -- "-- Choice: "
	read -r choice
	echo

	case "${choice}" in
		90)
			/bin/sh
			;;
		91)
			printf -- "-- Image name: "
			read -r image
			;;
		92)
			printf -- "-- Boot device: "
			read -r boot_dev
			;;
		99)
			sync
			reboot -f
			;;
		*)
			image=$(grep " ${choice})" images.list)
			image=${image##* }
			;;
	esac
done
