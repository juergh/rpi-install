#!/bin/sh
#
# Download and install a Raspberry Pi image from a Redfish API server
#

REDFISH_HOST=192.168.99.11:5000

echo "-- Run installer"

/bin/busybox --install /bin

[ -d /dev ] || mkdir -m 0755 /dev
[ -d /root ] || mkdir -m 0700 /root
[ -d /sys ] || mkdir /sys
[ -d /proc ] || mkdir /proc
[ -d /tmp ] || mkdir /tmp
[ -d /boot ] || mkdir /boot
mkdir -p /var/lock
mount -t sysfs -o nodev,noexec,nosuid sysfs /sys
mount -t proc -o nodev,noexec,nosuid proc /proc

mount -t devtmpfs -o nosuid,mode=0755 udev /dev
mkdir /dev/pts
mount -t devpts -o noexec,nosuid,gid=5,mode=0620 devpts /dev/pts || true

echo "-- Wait for /dev/mmcblk0p1"
# shellcheck disable=SC2034
for i in $(seq 10) ; do
	[ -b /dev/mmcblk0p1 ] && break
    sleep .5
done

echo "-- Mount /dev/mmcblk0p1"
if mount /dev/mmcblk0p1 /boot ; then
	# Clear the one-time boot flag
	sed -i 's,^# rpi-install ONCE ,,' /boot/config.txt

	echo "-- Unmount /dev/mmcblk0p1"
	sync
	umount /boot
fi

echo "-- Load kernel modules"
depmod
modprobe r8152

echo "-- Wait for /sys/class/net/eth0"
# shellcheck disable=SC2034
for i in $(seq 10) ; do
	[ -e /sys/class/net/eth0 ] && break
	sleep .5
done

echo "-- Get an IP"
dhclient

echo "-- Query Redfish host ${REDFISH_HOST}"
# shellcheck disable=SC2002
serial=$(cat /proc/device-tree/serial-number | tr -d '\0\n')
data=$(wget -q -O - "http://${REDFISH_HOST}/redfish/v1/Systems/${serial}/Actions/ComputerSystem.Update" | \
	   tr -d '\n' | \
	   sed 's,":\s*",":",g')
# Extract the update status from the response
status=${data#*\"Status\":\"}
status=${status%%\"*}
if [ "${status}" = "Pending" ] ; then
	# Extract the Image name from the respone
	image=${data#*\"Image\":\"}
	image=${image%%\"*}
	if [ -n "${image}" ] ; then
		# Clear the pending update
		wget -q -O - "http://${REDFISH_HOST}/redfish/v1/Systems/${serial}/Actions/ComputerSystem.Update.Delete"
	fi
fi

# Run the interactive installer
while true ; do
	if [ -n "${image}" ] ; then
		image_url="http://${REDFISH_HOST}${image}"
		echo "-- Install image ${image_url}"
		if wget -O - "${image_url}" | gunzip -c > /dev/mmcblk0 ; then
			sync
			reboot -f
		fi
	fi

	cat <<__EOF__

-- Select an image to install

      1) Groovy - arm64
      2) Groovy - armhf
      3) Focal  - arm64
      4) Focal  - armhf
      5) Bionic - arm64
      6) Bionic - armhf

     10) Core20 - arm64
     11) Core20 - armhf
     12) Core18 - arm64
     13) Core18 - armhf
     14) Core16 - arm64
     15) Core16 - armhf

     20) Raspberry Pi OS Lite - arm64
     21) Raspberry Pi OS Lite - armhf

     90) Run a shell
     91) Enter an image name manually
     99) Reboot

__EOF__

	# shellcheck disable=SC2039
	echo -n "-- Choice: "
	read -r tmp

	case "${tmp}" in
		#
		# Ubuntu Server
		#
		1) image=/redfish/v1/Images/ubuntu-groovy-arm64 ;;
		2) image=/redfish/v1/Images/ubuntu-groovy-armhf ;;
		3) image=/redfish/v1/Images/ubuntu-focal-arm64  ;;
		4) image=/redfish/v1/Images/ubuntu-focal-armhf  ;;
		5) image=/redfish/v1/Images/ubuntu-bionic-arm64 ;;
		6) image=/redfish/v1/Images/ubuntu-bionic-armhf ;;

		#
		# Ubuntu Core
		#
		10) image=/redfish/v1/Images/ubuntu-core20-arm64 ;;
		11) image=/redfish/v1/Images/ubuntu-core20-armhf ;;
		12) image=/redfish/v1/Images/ubuntu-core18-arm64 ;;
		13) image=/redfish/v1/Images/ubuntu-core18-armhf ;;
		14) image=/redfish/v1/Images/ubuntu-core16-arm64 ;;
		15) image=/redfish/v1/Images/ubuntu-core16-armhf ;;

		#
		# Raspberry Pi OS
		#
		20) image=/redfish/v1/Images/raspios-lite-arm64 ;;
		21) image=/redfish/v1/Images/raspios-lite-armhf ;;

		#
		# Misc options
		#
		90)
			/bin/sh
			;;
		91)
			# shellcheck disable=SC2039
			echo -n "-- Image name: "
			read -r image
			;;
		99)
			sync
			reboot -f
			;;

		#
		# Default
		#
		*)
			;;
	esac
done
